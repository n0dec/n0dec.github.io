function format_to_rule(data) {
	rules = {};
	var raw_split = data.split('\n\n');

	for(var n = 0; n < raw_split.length; n++){
		raw_split2 = raw_split[n].split('\n');
		if(raw_split2 != ''){
			iter = n + 1
			rules['rule' + iter] = {}
			rules['rule' + iter].enabled = true;
			rules['rule' + iter].source = "Sysmon";
			rules['rule' + iter].category = raw_split2[0].slice(0, -1);
			rules['rule' + iter].description = 'Description for rule' + iter;
			rules['rule' + iter].payload = {}

			for (var i = 1; i < raw_split2.length; i++) {
				var f_split = raw_split2[i].split(': ')
				rules['rule' + iter].payload[f_split[0]] = f_split[1]
			}
		}
	}
	json_rules(rules);
}

function text_to_rule(data){
	rules = {};
	var raw_split = data.split('\n\n');
	for(var n = 0; n < raw_split.length; n++){
		raw_split2 = raw_split[n].split('\n');
		if(raw_split2 != ''){
			iter = n + 1
			rules['rule' + iter] = {}
			rules['rule' + iter].enabled = true;
			rules['rule' + iter].source = "Sysmon";
			rules['rule' + iter].category = raw_split2[13].slice(0, -1);
			rules['rule' + iter].description = 'Description for rule' + iter;
			rules['rule' + iter].payload = {}

			for (var i = 14; i < raw_split2.length; i++) {
				var f_split = raw_split2[i].split(': ')
				rules['rule' + iter].payload[f_split[0]] = f_split[1]
			}
		}
	}
	json_rules(rules);
}

function xml_to_rule(data){
	rules = {};
	var raw_split = data.split('\n');
	parser = new DOMParser();
	for(var n = 0; n < raw_split.length; n++) {
		var xmlDoc = parser.parseFromString(raw_split[n], "text/xml");
		console.log(xmlDoc);
		var nodes = xmlDoc.getElementsByTagName("EventData")[0].childNodes;
		for (var i = 0; i < nodes.length; i++){
			console.log(nodes[i].getAttribute("Name") + nodes[i].nodeValue);
		}
		// console.log(raw_split[n].match(/<EventID>(\d+?)<\/EventID>/i));
		// console.log(raw_split[n].match(/<Data Name=\'(\w+?)\'>(.*?)<\/Data>/gi));
	}
}

function json_rules(rules){
	var set = {}

	set['name'] = "Rule set name";
	set['version'] = "0.1";
	set['author'] = "autogenerated";
	set['description'] = "Description for rule set.";
	set.rules = rules;

	var json = JSON.stringify(set, null, "\t");
	document.getElementById("rule").innerHTML = json;
}

function rule_format() {
	var data = document.getElementById("raw").value;
	var first_line = data.split('\n')[0];

	if (first_line.substring(0, 6) == '<Event'){
		console.log('case 3');
		xml_to_rule(data);
	} else if ((first_line.indexOf(':') != -1) && (first_line.indexOf('[') == -1)) {
		console.log('case 1');
		format_to_rule(data);
	} else if (first_line.substring(0, 6) == 'Event[') {
		console.log('case 2');
		text_to_rule(data);
	} else {
		console.log('format not recognized');
	}
}
